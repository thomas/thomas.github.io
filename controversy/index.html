<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Delicious Controversy: Docs & Tests</title>

		<meta name="author" content="Thomas Meeks">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/default.css" id="theme">

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">
				<section>
          <section>
            <img src="./images/delicious.jpg">
            <p class="attribution">
            http://www.flickr.com/photos/mumumio/8356659421/<br/>
            Attribution-NonCommercial License<br/>
            </p>
          </section>
					<section>
						<h1>delicious controversy</h1>
            <h1>Docs &amp; Tests</h1>
            <br/>
            <br/>
            <p>Thomas Meeks</p>
					</section>
          <section>
            <h1>Why?</h1>
          </section>
          <section>
            <h1>Over 27,000 lines</h1>
            <h1>29 committers</h1>
            <h1>Lots of rotation</h1>
          </section>
          <section>
            <h1>Lessons Learned</h1>
          </section>
          <section>
            <h1>Champion Practicality</h1>
          </section>
          <section>
            <h1>Docs!</h1>
          </section>
          <section>
            <h2>subscription.cancel</h2>
          </section>
          <section>
            <h2>subscription.cancel!</h2>
          </section>
					<section>
						<h2>Self Documenting Code is a Pipe Dream</h2>
					</section>
          <section>
            <img src="./images/puzzle_piece.jpg">
            <p class="attribution">
            Puzzle piece by Joey Day<br/>
            http://www.flickr.com/photos/joeyday/147651554/<br/>
            Attribution License<br/>
            </p>
          </section>
          <section>
            <img src="./images/umpossible.jpg">
            <p class="attribution">
            Umpossible! by Ben<br/>
            http://www.flickr.com/photos/mrbenn/768375889/<br/>
            Attribution-NonCommercial-NoDerivs License<br/>
            </p>
          </section>
          <section>
            <h1>It can be done</h1>
            <h2>But it takes too damn long</h2>
            <h2>Also soul-crushing</h2>
          </section>
          <section>
            <h1>Tests are Terrible Documentation</h1>
          </section>
          <section>
            <h2 >In order to understand these 11,000 lines of code, please sift through 16,000 lines of rspec.</h2>
          </section>
          <section>
            <img src="./images/torture.jpg">
          </section>
          <section>
            <h2>Exist so others can use classes without deeply understanding them</h2>
          </section>
					<section>
						<h1>Sane &amp; Useful Docs</h1>
						<ul>
							<li>Document all public methods</li>
							<li>Document as you go</li>
							<li>Keep it short</li>
							<li>Do not document implementation</li>
            </ul>
          </section>
          <section>
						<h1>Answer three questions</h1>
            <ul>
              <li>What does the method need?</li>
              <li>What does the method do?</li>
              <li>What are the far-reaching consequences?</li>
						</ul>
					</section>
          <section>
            <h1>Treat it like a public API</h1>
					</section>
          <section>
            <img src="./images/jigsaw_box.jpg">
            <p class="attribution">
            Jigsaw puzzle of ‘GWR The Torbay Express 375’, Chad Valley Co Ltd, 1939 by Birmingham Museum and Art Gallery</br>
            http://www.flickr.com/photos/birminghammag/7920558348/</br>
            Attribution License </br>
            </p>
          </section>
          <section>
            <h1>Testing!</h1>
          </section>
          <section>
            <h1>We have 16,000 lines of specs</h1>
          </section>
          <section>
            <h1>5,000 more lines than application code</h1>
          </section>
          <section>
            <h1>16,000 lines of maintenance</h1>
          </section>
          <section>
            <h1>Why?</h1>
          </section>
          <section>
            <h1>Prevent Bugs</h1>
          </section>
          <section>
            <h1>Unit Tests</h1>
            <h2>Test a method without "leaving" the class</h2>
          </section>
          <section>
            <h1>Unit Tests are bad tests</h1>
            <ul>
              <li>Too many lines of test code per line covered.</li>
              <li>Too coupled to implementation.</li>
              <li>Creates too much maintenance.</li>
              <li>Creates too many bugs.</li>
            </ul>
          </section>
					<section>
						<h1>TDD creates bad tests</h1>
					</section>
					<section>
						<h1>TDD is about good design, not good tests</h1>
					</section>
					<section>
						<h1>But TDD does not guarantee good design</h1>
            <h2>(So stop acting like it does)</h2>
					</section>
          <section>
            <img src="./images/burn.jpg">
          </section>
          <section>
            <h1>Use TDD if it works for you</h1>
            <h2>But please delete your unit tests</h2>
          </section>
          <section>
            <h1>Integration Tests</h1>
            <h2>Test the "full stack", check the result</h2>
          </section>
          <section>
            <h1>Integration tests are beautiful</h1>
            <ul>
              <li>Efficienly tests a lot of code</li>
              <li>Tests our complex interactions</li>
              <li>Right mindset: make sure the feature works</li>
            </ul>
          </section>
          <section>
            <h1>So Capybara?</h1>
          </section>
          <section>
            <h1>Nope</h1>
            <ul>
              <li>Takes too long to implement</li>
              <li>Too much maintenance</li>
              <li>Too many gotchas</li>
              <li>Doesn't encourage good code</li>
              <li>View changes tend to break tests</li>
            </ul>
          </section>
          <section>
            <h1>So, what then?</h1>
          </section>
          <section>
            <h1>Sane Tests</h1>
            <h2>Models, Services, and Presenters</h2>
          </section>
          <section>
            <h1>Model</h1>
            <ul>
              <li>Core application logic</li>
              <li>Do one thing, do it well</li>
              <li>Not necessarily ActiveRecord</li>
            </ul>
          </section>
          <section>
          <h2>Before:</h2>
<pre><code>def charge 
  if billing_object.charge
    self.paid = true
    self.next_bill_on = 30.days.from_now
  else
    self.paid = false
    self.next_bill_on = 1.day.from_now
  end
end

def billing_object
  Billing::Subscription.find(self.id)
end
</code></pre>
          </section>
          <section>
          <h2>After:</h2>
<pre><code># @!attribute paid?
#   @return [Boolean] true if payment is current

# Immediately attempts a charge to renew the subscription,
# and updates the paid status. Also updates next_bill_on 
# so we know when to try again.
#
# @return [Date] the next time a charge should be attempted
# @raise  [BillingUnavailableError] if billing is down
def charge 
  if billing_object.charge
    self.paid = true
    self.next_bill_on = 30.days.from_now
  else
    self.paid = false
    self.next_bill_on = 1.day.from_now
  end
end

private :billing_object # who cares?
</code></pre>
          </section>
          <section>
          <h2>Testing:</h2>
<pre><code>VCR.use_cassette('valid_subscription') do
  subscription = Factory.new(:valid_subscription)
  subscription.charge

  assert subscription.paid
  assert_equal 30.days.from_now, subscription.next_bill_on
end
</code></pre>
          </section>
					<section>
						<h1>Service</h1>
            <ul>
              <li>Orchestrates models</li>
              <li>Handles logic that doesn't fit into a model</li>
              <li>Helps controllers become paper-thin</li>
            </ul>
					</section>
          <section>
            <h2>Before Service:</h2>
<pre><code>def create
  @subscription = Subscription.new(params[:subscription])

  if @subscription.valid?
    discount = Discount.find_for_subscription(@subscription)
    @subscription.add_discount(discount)
    @subscription.charge

    redirect_to user_path(current_user)
  else
    render :new
  end
end
</code></pre>
          </section>
					<section>
						<h2>After Service:</h2>
<pre><code>def create
  @service = SubscriptionService.new(params[:subscription])

  if @service.create
    redirect_to user_path(current_user)
  else
    render :new
  end
end
</code></pre>
					</section>
          <section>
            <h2>Documenting a Service:</h2>
<pre><code>  # Creates a new subscription and applies a discount to it,
  # if appropriate. Immediately charges the subscription.
  #
  # @return [Boolean] true if the operation was successful
  # @raise  [BillingDownError] if the billing system is down
  def create
    if @subscription.valid?
      discount = Discount.find_for_subscription(@subscription)
      @subscription.add_discount(discount)
      @subscription.charge
      @subscription.paid?
    else
      false
    end
  end
</code></pre>
					</section>
					<section>
						<h2>Testing a Service:</h2>
<pre><code>discount = Factory.new(:global_discount)
service = SubscriptionService.create(good_params)

assert service.create
assert service.subscription.paid?

assert_equal discount, service.subscription.discount
</code></pre>
					</section>
					<section>
						<h2>Presenter</h2>
						<ul>
              <li>Helps display complex views</li>
              <li>Template (and framework) agnostic</li>
              <li>Helps controllers, and views, become paper-thin</li>
            </ul>
					</section>
          <section>
            <h2>Before Presenter:</h2>
<pre><code>def show
  @subscription.find(params[:id])
  @user = @subscription.user
end
</code></pre>
<pre><code>.subscription-data
  .label= @subscription.name
  .label= @subscription.active? ? @subscription.expiry : "None!"
.course-data
  .label= @user.courses.completed.count
  .label= @user.next_recommended_course || "That's all folks!"
</code></pre>
          </section>
					<section>
						<h2>After Presenter:</h2>
<pre><code>def show
  @presenter = SubscriptionPresenter.new(params[:id])
end
</code></pre>
<pre><code>.subscription-data
  .label= @presenter.name
  .label= @presenter.expiration_date
.course_data
  .label= @presenter.completed_course_count
  .label= @presenter.next_recommended_course
</code></pre>
					</section>
          <section>
            <h2>Documenting a Presenter:</h2>
<pre><code># @return [String] the name of the subscription
def name
  @subscription.name
end

# @return [String] the expiration date in string format
def expiration_date
  @subscription.active? ? @subscription.expiry : "None!"
end

# @return [Integer] user's completed course count 
def completed_course_count
  @user.completed_course_count
end

# @return [String] the user's next recommended course
def next_recommended_course
  @user.next_recommended_course || "That's all folks!"
end
</code></pre>
					</section>
					<section>
						<h2>Testing a Presenter:</h2>
<pre><code>subscription = Factory.new(:subscription)
presenter    = SubscriptionPresenter.new(subscription)

assert_equal subscription.name, @presenter.name
assert_equal "1/1/2014", @presenter.expiration_date
assert_equal 5, @presenter.completed_course_count
assert_equal "Backbone", @presenter.next_recommended_course
</code></pre>
					</section>
					<section>
						<h2>What about Controllers & Views?</h2>
					</section>
					<section>
						<h2>They should be so simple tests are a waste of time</h2>
					</section>
          <section>
            <h2>Even if you have to pull parameter processing & redirects into a service</h2>
          </section>
          <section>
            <h1><s>skinny</s></h1>
            <h1>skeletal controllers</h1>
          </section>
          <section>
            <h1>Guidelines</h1>
            <ul>
              <li>Every class is an API defined by its public methods</li>
              <li>A method should only be public if it must be</li>
              <li>Document public methods</li>
              <li>Write feature/integration tests for public methods</li>
              <li>Every line of code has a maintenance cost, even if they are tests</li>
              <li>Refactor slowly, do not engage the "big refactor"</li>
              <li>These are guidelines, bend freely</li>
            </ul>
					</section>
          <section>
            <h1>Exceptions to the rules!</h1>
            <ul>
              <li>Especially critical code</li>
              <li>Algorithmically complex code</li>
              <li>Code that breaks frequently</li>
              <li>HTTP APIs (headers are an important part of the contract)</li>
            </ul>
          </section>
          <section>
            <h1>Mindset is Important</h1>
            <ul>
              <li>No controller testing = very simple controllers</li>
              <li>No view testing = very simple views</li>
              <li>Test &amp; document public methods = make sure it really needs to be public</li>
              <li>No private method tests = good feature tests</li>
              <li>Less time trying to understand code = happier programmers</li>
              <li>Less time maintaining tests = happier programmers</li>
              <li>Working the way that works for you = happier programmers</li>
            </ul>
          </section>
          <section>
            <h1>Thanks!</h1>
            <h2>thomasmeeks.com/controversy</h2>
          </section>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,

				theme: 'beige', // Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/showdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
